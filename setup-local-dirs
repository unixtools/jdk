#!/bin/bash

umask 077
cd /local/jdk
mkdir -p tar

WHICH="$1"
if [ "x$WHICH" = "x" ]; then
	#echo "Usage: $0 [8-64|11-64|21-64]"
	#exit 1
	WHICH="21-64"
fi
echo "Setting up for: $WHICH"


case "$WHICH" in
	21-64)
		URL=https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.8%2B9/OpenJDK21U-jdk_x64_linux_hotspot_21.0.8_9.tar.gz
		FILE=`basename $URL`
		TGT=jdk-21.0.8+9
		SUFFIX=""
		VSUFFIX=21
		;;
	17-64)
		URL=https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.16%2B8/OpenJDK17U-jdk_x64_linux_hotspot_17.0.16_8.tar.gz
		FILE=`basename $URL`
		TGT=jdk-17.0.16+8
		SUFFIX=""
		VSUFFIX=17
		;;
	11-64)
		URL=https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.28%2B6/OpenJDK11U-jdk_x64_linux_hotspot_11.0.28_6.tar.gz
		FILE=`basename $URL`
		TGT=jdk-11.0.28+6
		SUFFIX=""
		VSUFFIX=11
		;;
	8-64)
		URL=https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u462-b08/OpenJDK8U-jdk_x64_linux_hotspot_8u462b08.tar.gz
		FILE=`basename $URL`
		TGT=jdk8u462-b08
		SUFFIX=""
		VSUFFIX=8
		;;
	*)
		echo "Undefined gen-bits."
		exit 1
		;;
esac

if [ ! -e /usr/bin/curl ]; then
	if [ ! -e tar/$FILE ]; then
		wget --no-cookies $URL -O tar/$FILE
	fi

else

	if [ ! -e tar/$FILE ]; then
		curl -k -L $URL -o tar/$FILE
	fi
fi


if [ ! -e "${TGT}${SUFFIX}" ]; then
	unset DISPLAY
	chmod 755 tar/$FILE
	rm -rf tmpextract
	mkdir -p tmpextract
	cd tmpextract
	case $FILE in
		*.bin)
			../tar/$FILE
			;;
		*.tar.gz)
			tar -xzf ../tar/$FILE
			;;
	esac
	cd ..
	mv tmpextract/$TGT ${TGT}${SUFFIX}
	rm -rf tmpextract
fi

rm -f latest${SUFFIX}
ln -s $TGT latest${SUFFIX}

rm -f latest-${VSUFFIX}
ln -s $TGT latest-${VSUFFIX}

./add-local-certs

if [ -e /etc/profile.d ]; then
	rm -f /etc/profile.d/jdk.sh
	rm -f /etc/profile.d/java-home.sh
	cp java-home.sh /etc/profile.d/java-home.sh
	chmod 755 /etc/profile.d/java-home.sh
fi

chown -R root:root /local/jdk
chmod -R ugo+rX /local/jdk
