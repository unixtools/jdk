#!/bin/sh

cd /local/jdk
mkdir -p tar

WHICH="$1"
if [ "$WHICH" == "" ]; then
	echo "Usage: $0 [6-32|6-64|7-64]"
	exit 1
fi

BASE=http://download.oracle.com/otn-pub/java/jdk
CRYPTO_BASE=http://download.oracle.com/otn-pub/java/jce

case "$WHICH" in
	7-64)
		URL=$BASE/7u45-b18/jdk-7u45-linux-x64.tar.gz
		FILE=`basename $URL`
		TGT=jdk1.7.0_45
		SUFFIX=""
		CRYPTO_URL=$CRYPTO_BASE/7/UnlimitedJCEPolicyJDK7.zip
		CRYPTO_FILE=`basename $CRYPTO_URL`
		CRYPTO_TGT=UnlimitedJCEPolicy
		;;
	6-64)
		URL=$BASE/6u45-b06/jdk-6u45-linux-x64.bin
		FILE=`basename $URL`
		TGT=jdk1.6.0_45
		SUFFIX=""
		CRYPTO_URL=$CRYPTO_BASE/6/UnlimitedJCEPolicyJDK6.zip
		CRYPTO_FILE=`basename $CRYPTO_URL`
		CRYPTO_TGT=UnlimitedJCEPolicy
		;;
	6-32)
		URL=$BASE/6u45-b06/jdk-6u45-linux-i586.bin
		FILE=`basename $URL`
		TGT=jdk1.6.0_45
		SUFFIX="-32bit"
		CRYPTO_URL=$CRYPTO_BASE/6/UnlimitedJCEPolicyJDK6.zip
		CRYPTO_FILE=`basename $CRYPTO_URL`
		CRYPTO_TGT=UnlimitedJCEPolicy
		;;
	*)
		echo "Undefined gen-bits."
		exit 1
		;;
esac

if [ ! -e tar/$FILE ]; then
	wget --no-cookies --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com" \
	$URL -O tar/$FILE
fi

if [ ! -e tar/$CRYPTO_FILE ]; then
	wget --no-cookies --header "Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com" \
	$CRYPTO_URL -O tar/$CRYPTO_FILE
fi

if [ ! -e "${TGT}${SUFFIX}" ]; then
	unset DISPLAY
	chmod 755 tar/$FILE
	rm -rf tmpextract
	mkdir -p tmpextract
	cd tmpextract
	case $FILE in
		*.bin)
			../tar/$FILE
			;;
		*.tar.gz)
			tar -xzf ../tar/$FILE
			;;
	esac
	cd ..
	mv tmpextract/$TGT ${TGT}${SUFFIX}
	rm -rf tmpextract
fi

case $FILE in
	*1.7*)
		rm -f jdk1.6${SUFFIX}
		ln -s $TGT jdk1.6${SUFFIX}
		;;
	*1.7*)
		rm -f jdk1.7${SUFFIX}
		ln -s $TGT jdk1.7${SUFFIX}
		;;
esac

rm -f latest${SUFFIX}
ln -s $TGT latest${SUFFIX}

echo "Installing crypto policy extensions..."
rm -rf tmpextract
mkdir -p tmpextract
cd tmpextract
unzip ../tar/$CRYPTO_FILE
cd ..
cp tmpextract/$CRYPTO_TGT/* /local/jdk/$TGT/jre/lib/security/
rm -rf tmpextract

./add-local-certs

rm -f /etc/profile.d/jdk.sh
rm -f /etc/profile.d/java-home.sh
cp java-home.sh /etc/profile.d/java-home.sh
chmod 755 /etc/profile.d/java-home.sh

chown -R root:root /local/jdk
